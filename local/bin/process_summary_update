#!/bin/bash

scriptdir=$( (cd -P $(dirname $0) && pwd) )
solrmarcdir=$( (cd -P $(dirname $0)/.. && pwd) )
if ! [ -e $solrmarcdir/SolrMarc.jar ]
then
  solrmarcdir=$( (cd -P $(dirname $0)/../../import && pwd) )
fi
outputtmpdir=$( (cd -P $(dirname $0)/../tmpdata && pwd) )
configdir=$( (cd -P $(dirname $0)/../import && pwd) )

summary_update_file=$1
summ_fname=`basename $summary_update_file .xml`
marc_update_file_ids=marc_update_${summ_fname}.txt
marc_update_file=marc_update_${summ_fname}.mrc

echo "Indexing file $summ_fname into syndetics summary core"
cat $summary_update_file | $scriptdir/syn2marc - | $scriptdir/indexfile $configdir/summ_config.properties 

echo "Extracting list of ids in biblio core that match an isbn in file $summ_fname"
for isbn in `cat $summary_update_file | $scriptdir/syn2marc - | 
               $scriptdir/printrecord $scriptdir/syn_config.properties 020  |  
               sed -e 's/020   $a//' | sort | uniq`
do
    curl -s "http://localhost:8080/solr/biblio/select?q=isbn%3a$isbn&fl=id" | 
        xmllint --format - | egrep '"id"' | 
        sed -e 's/.*"id">\([0-9]*\)<.*/\1/' 
done  |  sort | uniq >  $outputtmpdir/$marc_update_file_ids

#cat /home/vufind/fullMarc/bib_vufind_marc_marc-8_0*.mrc | getrecord - $marc_update_file_ids > $marc_update_file
#or
echo "Extracting MARC records from biblio core based matching the list of id just extracted"
for id in `cat $outputtmpdir/$marc_update_file_ids`
do
    $scriptdir/getfromsolr "http://localhost:8080/solr/biblio" "id:$id" fullrecord
done > $outputtmpdir/$marc_update_file

echo "Indexing extracted records back into the biblio core"
$scriptdir/indexfile $configdir/import_ole_syn.properties $outputtmpdir/$marc_update_file

echo "Done processing summary update file $summ_fname"
